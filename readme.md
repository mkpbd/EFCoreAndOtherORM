Install Efcore

1. microsoft.entityframeworkcore
2. microsoft.entityframeworkcore.design
3. microsoft.entityframeworkcore.sqlserver
4. microsoft.entityframeworkcore.tools
5. microsoft.Extensions.Configuration
6. Microsoft.Extensions.Configuration.FileExtensions
7. Microsoft.Extensions.Configuration.Json

```csharp
//Add a default constructor if scaffolding is needed
public ApplicationDbContext() { }
//Add the complex constructor for allowing Dependency Injection
public ApplicationDbContext(DbContextOptions options)
:base(options)
{
//intentionally empty.
}
```

Adding the **DBOptions** as an injectable object to the constructor and creating the default constructor with no parameters

The name of the constructor is the exact same as the name of the class, and the new constructor has one injectable parameter of type **DbContextOptions**. This parameter will include critical information, such as the connection string to your database. Making these options injectable will ensure that the context can be used from any application pointing to any correctly configured database.

#### **Create the ability to connect and use the Database DBContext**

Add another static variable to store the options builder information. This is a **DbContextOptionsBuilder** object, which is a generic, with a type argumentn that contains the type of your generated **DbContext**

#### What is the DBContext

A **DbContext** instance represents a session with the database and can be used to query and save instances of your entities. DbContext is a combination of the unit of work and repository patterns.

Using the **DbContext**, therefore, we get orchestration around two significant patterns in database development, the unit of work (UoW) pattern, and the repository design pattern. This means that by using the DBContext, we don’t have to explicitly manage simple transactions when working with the **DBContext**, as they will be handled by the context implementing the UoW pattern.

The **DBContextOptionsBuilder** gives us a couple of critical operations that we’ll leverage. In the last chapter, we set the type of database we wanted to use and injected the connection string for the **DBContext** through the DBContextOptionsBuilder and the **DBContextOptions**

```csharp
protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
{
if (!optionsBuilder.IsConfigured)
{
var builder = new ConfigurationBuilder()
.SetBasePath(Directory.GetCurrentDirectory())
. AddJsonFile("appsettings.json", optional: true,
reloadOnChange: true);
_configuration = builder.Build();
var cnstr = _configuration.GetConnectionString("InventoryManager");
optionsBuilder.UseSqlServer(cnstr);
}
}
```

which is easily generated by creating a new ASP.Net MVC project

```csharp
public void ConfigureServices(IServiceCollection services)
{
services.AddDbContext<ApplicationDbContext>(options =>
options.UseSqlServer(
Configuration.GetConnectionString("DefaultConnection")));
services.AddDatabaseDeveloperPageExceptionFilter();
services.AddDefaultIdentity<IdentityUser>(options =>
options.SignIn.RequireConfirmedAccount = true)
.AddEntityFrameworkStores<ApplicationDbContext>();
services.AddControllersWithViews();
}
```

Important properties on the DbContextOptionsBuilder object

| Property     | Purpose                                                                                    |
| ------------ | ------------------------------------------------------------------------------------------ |
| IsConfigured | Gets a value indicating whether any options have been configured.                          |
| Options      | Gets the options being configured by giving direct access to the DBContextOptions object. |

Important properties on the DBContextOptions object

| Property    | Purpose                                                                                                                                                                    |
| ----------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ContextType | Gets the type for the context; if no type is defined, then DBContext will be returned.                                                                                     |
| Extensions  | Gets a list of extensions as configured, such as the type of database being leveraged.                                                                                    |
| IsFrozen    | Used to determine if the DBContext is open for further configuration.<br /> If true, the system cannot further override the context options in the OnConfiguring method. |

**Important properties on the DBContext object**

| Property      | Purpose                                                                                                                                                                                                                                                                               |
| ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ChangeTracker | Allows us to get direct information about the interactions with entities in our context.<br />Can be used to determine if Lazy Loading is enabled, if the context entities have changes, <br />and is leveraged for major operations like accepting changes and cascading deletes. |
| ContextId     | Every context has a unique id. This can be useful information for logging what<br /> context was being leveraged to perform an operation when there are multiple contexts or multiple instances of a context.                                                                       |
| Database      | This property implements a façade on the database and is primarily used for  determining<br />and working with critical database operations like connections, commands, and transactions.                                                                                         |
| Model         | Gets the metadata for the underlying entities and relationships as mapped in the database.                                                                                                                                                                                           |

#### Methods available on the DBContext

| Method                       | Purpose                                                                                                                                                                                                                                                             |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Add/AddAsync / AddRange     | Allows insertion of the entity into the database; begins tracking the entity.<br />Added objects will be tracked and will be added once the SaveChanges method is called.<br />including an AddRange method, which allows adding more than one entity at a time. |
| Find/FindAsync               | Find a specific entity by the entity’s primary key value (generally an Id).                                                                                                                                                                                        |
| OnConfiguring                | Allows for us to override the options and other information about the database.                                                                                                                                                                                    |
| OnModelCreating              | Allows us to use the FluentAPI to further define our entities and their<br />relationships by configuring the models, their properties, and any relationships.                                                                                                    |
| Remove                       | Delete an entity from the database. This option also has a RemoveRange ability.                                                                                                                                                                                    |
| SaveChanges/SaveChangesAsync | Apply the tracked changes in a single transaction                                                                                                                                                                                                                   |
| Update                       | Used to perform an update to the tracked entity. There is also an ability to update a range of tracked entities with UpdateRange.                                                                                                                                  |
|                              |                                                                                                                                                                                                                                                                     |
|                              |                                                                                                                                                                                                                                                                     |
|                              |                                                                                                                                                                                                                                                                     |

Methods and extensions on the DBSet `<TEntity>` object

| Name                  | Method or<br />Extension | Purpose                                                                                                                                                                                       |
| --------------------- | ------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Add/AddAsync          |                          | Adds the entity to the context for insert, begins tracking the entity, and the entity is added on the call to SaveChanges.<br />Also has an AddRange option to do multiple entities at once. |
| AsNoTracking          | Method                   | Gets an entity that is not tracked so that any modifications do not cause concurrency issues.<br />Calling SaveChanges will not persist any changes or modifications on the entity state.   |
| Find/FindAsync        | Method                   | Locates an entity by primary key (generally Id) and attaches to the current context. Returns null if no match is found.                                                                      |
| Include, ThenInclude | Method                   | Used to fetch related entities. Using Include and**ThenInclude** will be critical to <br />ensure that full data objects are attached to the context.                                  |
| Remove, RemoveRange  | Method                   | Sets the entity as deleted in the context . Changes are persisted only on the call to SaveChanges.<br />Also has a  RemoveRange option for multiple entities at once.                     |
| SqlQuery              | Method                   | Allows execution of a raw SQL Query.                                                                                                                                                          |
| Update , UpdateRange  | Method                   | Sets the entity state to modified for the tracked entity;  changes are persisted on call to SaveChanges.<br /> Also has an UpdateRange option to do multiples at once.                     |
| FirstOrDefaultAsync   | Extension                | Returns the first element that matches a provided condition, or null if no matches.                                                                                                          |
| SingleOrDefaultAsync  | Extension                | Returns the only possible match to a specified condition.<br /> If  multiple matches exist, throws an exception. If no matches exist, returns null.                                        |
|                       |                          |                                                                                                                                                                                               |
